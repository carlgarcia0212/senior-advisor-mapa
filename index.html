<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa Senior Advisor</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    #debug {
      position: absolute;
      bottom: 0;
      left: 0;
      background: rgba(0,0,0,0.7);
      color: #00ff90;
      font-size: 12px;
      padding: 8px;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      z-index: 9999;
      font-family: monospace;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkpdcq_Ul2DD_sKqgCXr0Cg9TRVwU12Zc"></script>
</head>
<body>
  <div id="map"></div>
  <div id="debug">üü¢ Consola inicializada</div>

  <script>
    const debug = (msg) => {
      const log = document.getElementById("debug");
      log.innerHTML += "<br>" + msg;
      console.log(msg);
    };

    const JSON_URL = "https://carlgarcia0212.github.io/senior-advisor-mapa/residencias.json";
    const ADALO_API_URL = "https://api.adalo.com/v0/apps/46b15754-5dde-409c-a825-90185f48da2c/collections/t_7slnxztk4hwnn9l2wtk2hxw0y";
    const ADALO_USERS_URL = "https://api.adalo.com/v0/apps/46b15754-5dde-409c-a825-90185f48da2c/collections/users";
    const ADALO_BEARER = "6sf063he4vxtqvsamoica6tbt";

    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("user_id");

    debug("üîé user_id desde URL: " + userId);

    if (!userId) {
      alert("‚ùå No se detect√≥ el usuario logueado.");
      throw new Error("Falta user_id");
    }

    let userData = null;

    async function obtenerUsuario(userId) {
      const url = `${ADALO_USERS_URL}/${userId}`;
      debug("üîó Consultando usuario en: " + url);
      const response = await fetch(url, {
        headers: {
          "Authorization": "Bearer " + ADALO_BEARER
        }
      });

      const raw = await response.text();
      debug("üì• Respuesta cruda: " + raw);

      if (!response.ok) {
        throw new Error("‚ùå Error al obtener usuario desde Adalo API");
      }

      return JSON.parse(raw);
    }

    function toNum(v) {
      const n = (typeof v === 'number') ? v : parseFloat(v);
      return Number.isFinite(n) ? n : null;
    }

    function addUserDot(map, pos) {
      new google.maps.Marker({
        position: pos,
        map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 6,
          fillColor: '#1a73e8',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2
        }
      });
    }

    async function guardarSeleccion(hogar) {
      if (!userData || !userData.username) {
        alert("‚ùå No se pudo obtener el username del usuario.");
        debug("üß® userData inv√°lido: " + JSON.stringify(userData));
        return;
      }

      const payload = {
        place_id: hogar.place_id || "",
        nombre_residencia: hogar.nombre_residencia || "",
        comuna: hogar.comuna || "",
        imagen_url: hogar.imagen_1 || "",
        username_logueado: userData.username,
        timestamp: new Date().toISOString()
      };

      debug("üì§ Enviando a Adalo: " + JSON.stringify(payload));

      try {
        const res = await fetch(ADALO_API_URL, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + ADALO_BEARER,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (res.ok) {
          debug("‚úÖ Guardado exitosamente.");
        } else {
          debug("‚ùå Error al guardar: " + text);
        }
      } catch (err) {
        debug("‚ùå Error t√©cnico al guardar: " + err.message);
      }
    }

    async function initMap() {
      try {
        userData = await obtenerUsuario(userId);
        debug("üë§ Usuario autenticado: " + userData.username);
      } catch (e) {
        alert("‚ùå Error al autenticar al usuario.");
        debug("‚ùå Error en auth: " + e.message);
        return;
      }

      let map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -33.45, lng: -70.65 },
        zoom: 12
      });

      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            addUserDot(map, userPos);
            map.setCenter(userPos);
            debug("üìç Posici√≥n del usuario detectada.");
          },
          () => {
            debug("‚ö†Ô∏è Geolocalizaci√≥n no autorizada.");
          },
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
        );
      }

      try {
        const resp = await fetch(JSON_URL, { cache: 'no-store' });
        if (!resp.ok) return;
        const hogares = await resp.json();

        let marcadorSeleccionado = null;

        hogares.forEach(hogar => {
          const lat = toNum(hogar.latitud_google);
          const lng = toNum(hogar.longitud_google);
          if (lat === null || lng === null) return;

          const marker = new google.maps.Marker({
            position: { lat, lng },
            map,
            title: hogar.nombre_residencia || ''
          });

          marker.addListener('click', () => {
            if (marcadorSeleccionado) {
              marcadorSeleccionado.setIcon(null);
            }

            marker.setIcon({
              path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
              scale: 5,
              fillColor: '#00e7ff',
              fillOpacity: 1,
              strokeColor: '#fff',
              strokeWeight: 2
            });

            marcadorSeleccionado = marker;
            debug("üìå Clic en: " + hogar.nombre_residencia);
            guardarSeleccion(hogar);
          });
        });

        debug("üì¶ Carga de residencias completada.");
      } catch (e) {
        debug("‚ùå Error al cargar residencias: " + e.message);
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>



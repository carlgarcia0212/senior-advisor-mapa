
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Senior Advisor - Mapa</title>
  <style>
    #map {
      height: 80vh;
      width: 100%;
    }
    #debug {
      padding: 10px;
      font-family: monospace;
      background: #f9f9f9;
      border-top: 1px solid #ccc;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="debug">Cargando mapa...</div>

  <script>
    const API_ADALO = "https://api.adalo.com/v0/apps/6sf063he4vxtqvsamoica6tbt"; // Cambia si usas otro
    const COLLECTION_NAME = "residencias_clicks"; // Aseg√∫rate que este sea el nombre correcto en Adalo
    const TOKEN_ADALO = "Bearer 08873f5270dbb3cfb7c5e7a55e5286be49cbf6f285b9d6c376ea66d6b95e4db7"; // Tu token de API

    const lugares = [
      {
        nombre: "Residencia Las Rosas",
        lat: -33.45694,
        lng: -70.64827,
        place_id: "residencia_las_rosas"
      },
      {
        nombre: "Residencia Santa Mar√≠a",
        lat: -33.45789,
        lng: -70.64671,
        place_id: "residencia_santa_maria"
      }
    ];

    const debug = (msg) => {
      const debugBox = document.getElementById("debug");
      debugBox.innerHTML += `<br>üß™ ${msg}`;
      console.log(msg);
    };

    const obtenerUsuario = async (userId) => {
      debug("Buscando username...");
      const res = await fetch(\`\${API_ADALO}/users/\${userId}\`, {
        headers: {
          Authorization: TOKEN_ADALO
        }
      });
      const data = await res.json();
      debug("Usuario detectado: " + data.username);
      return data.username;
    };

    const guardarSeleccion = async (residencia, username) => {
      const body = {
        place_id: residencia.place_id,
        nombre_residencia: residencia.nombre,
        username_logueado: username
      };

      const res = await fetch(\`\${API_ADALO}/collections/\${COLLECTION_NAME}\`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: TOKEN_ADALO
        },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        debug("‚úÖ Registro guardado en Adalo.");
      } else {
        debug("‚ùå Error al guardar. " + (await res.text()));
      }
    };

    const iniciarMapa = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      let userId = urlParams.get("user_id");
      debug("user_id en URL: " + userId);

      if (!userId) {
        debug("‚ùå No se encontr√≥ el par√°metro 'user_id' en la URL.");
        return;
      }

      let username = "";
      try {
        username = await obtenerUsuario(userId);
      } catch (e) {
        debug("‚ùå Error al obtener usuario.");
        return;
      }

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: lugares[0].lat, lng: lugares[0].lng }
      });

      lugares.forEach((residencia) => {
        const marker = new google.maps.Marker({
          position: { lat: residencia.lat, lng: residencia.lng },
          map,
          title: residencia.nombre
        });

        marker.addListener("click", () => {
          debug("üìç Clic en " + residencia.nombre);
          guardarSeleccion(residencia, username);
        });
      });
    };
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6g1eCBYUyhPWB_BbCeAwZGR9lvLUzSwg&callback=iniciarMapa"
    async
    defer
  ></script>
</body>
</html>



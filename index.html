<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Senior Advisor - Mapa</title>
  <style>
    #map {
      height: 80vh;
      width: 100%;
    }
    #debug {
      padding: 10px;
      font-family: monospace;
      background: #f9f9f9;
      border-top: 1px solid #ccc;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="debug">Cargando mapa...</div>

  <script>
    const API_ADALO = "https://api.adalo.com/v0/apps/46b15754-5dde-409c-a825-90185f48da2c";
    const COLLECTION_NAME = "t_7slnxztk4hwnn9l2wtk2hxw0y"; // ID real de tu colecciÃ³n
    const TOKEN_ADALO = "Bearer 6sf063he4vxtqvsamoica6tbt";

    const lugares = [
      { nombre: "Residencia Las Rosas", lat: -33.45694, lng: -70.64827, place_id: "residencia_las_rosas" },
      { nombre: "Residencia Santa MarÃ­a", lat: -33.45789, lng: -70.64671, place_id: "residencia_santa_maria" }
    ];

    const debug = (msg) => {
      const debugBox = document.getElementById("debug");
      debugBox.innerHTML += `<br>ğŸ§ª ${msg}`;
      console.log(msg);
    };

    const obtenerUsuario = async (userId) => {
      debug("Buscando username...");
      const res = await fetch(`${API_ADALO}/collections/users/${userId}`, {
        headers: { Authorization: TOKEN_ADALO }
      });
      const data = await res.json();
      debug("Usuario detectado: " + (data.username || "sin username"));
      return data.username;
    };

    const guardarSeleccion = async (residencia, username) => {
      const body = {
        place_id: residencia.place_id,
        nombre_residencia: residencia.nombre,
        username_logueado: username,
        timestamp: new Date().toISOString()
      };

      const res = await fetch(`${API_ADALO}/collections/${COLLECTION_NAME}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: TOKEN_ADALO
        },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        debug("âœ… Registro guardado en Adalo.");
      } else {
        debug("âŒ Error al guardar. " + (await res.text()));
      }
    };

    const iniciarMapa = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      let userId = urlParams.get("user_id");
      debug("user_id en URL: " + userId);

      if (!userId) {
        debug("âŒ No se encontrÃ³ el parÃ¡metro 'user_id' en la URL.");
        return;
      }

      let username = "";
      try {
        username = await obtenerUsuario(userId);
      } catch (e) {
        debug("âŒ Error al obtener usuario.");
        return;
      }

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: lugares[0].lat, lng: lugares[0].lng }
      });

      lugares.forEach((residencia) => {
        const marker = new google.maps.Marker({
          position: { lat: residencia.lat, lng: residencia.lng },
          map,
          title: residencia.nombre
        });

        marker.addListener("click", () => {
          debug("ğŸ“ Clic en " + residencia.nombre);
          guardarSeleccion(residencia, username);
        });
      });

      debug("ğŸŸ¢ Mapa inicializado.");
    };

    // Forzar inicio del mapa
    window.onload = iniciarMapa;
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkpdcq_Ul2DD_sKqgCXr0Cg9TRVwU12Zc"
    async
    defer
  ></script>
</body>
</html>




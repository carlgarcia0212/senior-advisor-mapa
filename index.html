<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa Senior Advisor - Place ID</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
  </style>
  <!-- Google Maps con Places API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkpdcq_Ul2DD_sKqgCXr0Cg9TRVwU12Zc&libraries=places"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    const JSON_URL = "https://carlgarcia0212.github.io/senior-advisor-mapa/residencias.json";
    const ADALO_API_URL = "https://api.adalo.com/v0/apps/46b15754-5dde-409c-a825-90185f48da2c/collections/t_7slnxztk4hwnn9l2wtk2hxw0y";
    const ADALO_BEARER = "6sf063he4vxtqvsamoica6tbt";

    let selectedMarker = null;

    async function initMap() {
      const map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -33.45, lng: -70.65 },
        zoom: 12
      });

      // UbicaciÃ³n del usuario (opcional)
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            new google.maps.Marker({
              position: userPos,
              map,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 6,
                fillColor: '#1a73e8',
                fillOpacity: 1,
                strokeColor: '#fff',
                strokeWeight: 2
              }
            });
            map.setCenter(userPos);
          },
          () => {},
          { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
        );
      }

      // Cargar JSON
      let hogares = [];
      try {
        const resp = await fetch(JSON_URL, { cache: 'no-store' });
        if (!resp.ok) throw new Error("No se pudo cargar el JSON");
        hogares = await resp.json();
      } catch (e) {
        console.error("Error cargando JSON:", e);
        return;
      }

      const service = new google.maps.places.PlacesService(map);

      hogares.forEach(hogar => {
        const placeId = hogar.place_id;
        if (!placeId) return;

        service.getDetails({
          placeId: placeId,
          fields: ['name', 'geometry']  // ðŸ‘ˆ clave: pedir explÃ­citamente los campos
        }, (place, status) => {
          if (status !== google.maps.places.PlacesServiceStatus.OK || !place.geometry) {
            console.warn("No se pudo obtener info de:", placeId, status);
            return;
          }

          const marker = new google.maps.Marker({
            position: place.geometry.location,
            map,
            title: hogar.nombre_residencia || '',
            icon: {
              path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
              scale: 5,
              fillColor: '#d60000',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2
            }
          });

          marker.addListener('click', () => {
            if (selectedMarker && selectedMarker !== marker) {
              selectedMarker.setIcon({
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                scale: 5,
                fillColor: '#d60000',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 2
              });
            }

            marker.setIcon({
              path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
              scale: 5,
              fillColor: '#00e7ff',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2
            });

            selectedMarker = marker;
            guardarSimple(hogar);
          });
        });
      });
    }

    async function guardarSimple(hogar) {
      const payload = {
        place_id: hogar.place_id || "",
        nombre_residencia: hogar.nombre_residencia || "",
        comuna: hogar.comuna || "",
        imagen_url: hogar.imagen_1 || ""
      };

      try {
        await fetch(ADALO_API_URL, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + ADALO_BEARER,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.warn("Error al guardar en Adalo", err);
      }
    }

    window.onload = initMap;
  </script>
</body>
</html>
